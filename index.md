# 地下街災害シミュレーション／Unityポートフォリオ

地下街災害シミュレーション（営業デモ）

■ プロジェクト概要

本プロジェクトは、模擬地下街を舞台に、
クライアント様が考案した特許技術を リアルタイムで可視化するシミュレーション です。

＜対象特許＞
「地下街往来者に現在位置を取得させる方法及び
現在位置から目的地までの経路を取得させる方法並びに
地下街往来者に対する避難誘導方法」
【公開番号】特開2021-25983（P2021-25983A）
URL：https://www.j-platpat.inpit.go.jp/p0200

⸻

本シミュレーションでは 地震・火災・複合災害 を想定し、
	•	平常時：地下街利用者が「現在地」と「目的地方向」を把握するプロセス
	•	災害時：避難方向・避難経路をどのように提示し、どのように行動を誘導するか

を、行政・企業向けの営業用デモとして分かりやすく提示することを目的としています。

⸻

このプロジェクトで最も重視しているのは、以下の点です：
	•	避難誘導システムを導入すると何ができるのか
	•	どの情報を、どのタイミングで、どの機器から出すべきか
	•	つまり、システムによって“何をどう実現したいのか”を具体的に伝えること

避難行動そのものの定量評価よりも、
特許技術のコンセプトと運用イメージを明確に伝える ことに重点を置いています。


■ 開発環境・技術構成（改訂版）
本シミュレーションは、macOS / Windows の両環境で動作するスタンドアロンアプリケーションとして構築しています。
Unity がインストールされていない環境でも単体で起動可能であり、営業デモ現場でも安定した動作が得られる構成としています。
 
● 開発環境
•	ゲームエンジン：Unity 2022.3.61f1（LTS）
•	ビルド形式：macOS / Windows 向けスタンドアロンアプリケーション
→ ブラウザ環境に依存せず、PC 単体で実行できる方式
•	プログラミング言語：C#
o	VS Code（Mac 環境）をコードエディタとして使用
•	外部連携ツール：
o	Arduino IDE（LED 点灯・タクトスイッチ制御用スケッチを作成）
o	Blender（主に一部オブジェクトの省ポリゴン化のために使用）
 
● 3D 空間の構築

本プロジェクトは、クライアント様が考案された「地下街往来者に対する避難誘導方法」を分かりやすく提示することが主目的であるため、
複雑な 3D モデルを作成する必要はなく、Unity 内で立方体・平面を組み合わせ、模擬地下街の構造を構成しています。
•	平面テクスチャによる簡易構造
•	ジオメトリを最小限に抑えられるため、高速描画が可能
•	広い空間でもポリゴン数が増えにくく、営業デモとして安定性を確保
 
● 経路探索ロジック（多源逆探索）

地下街の構造を正確に扱うため、一般的な NavMesh に加えて独自のノード／エッジデータ構造を用いています。
•	通路・交差点・出口を「ノード」としてデータ化
•	ノード間を「エッジ（通路）」として接続
•	**出口を起点とした多源逆探索（Multi-source Reverse Search）**により、
“現時点で最も安全な避難方向” を高速に算出
•	火災発生などの災害状況に応じて、封鎖されたノード・エッジを動的に除外

これにより、避難誘導システムが提示すべき方向情報を常に最新の状況に合わせてリアルタイム更新できる構造になっています。
 
● パフォーマンス最適化

営業デモでの安定動作を重視し、FPS や CPU 使用率などの指標を常時モニタリングしながら最適化を行っています。

1. 描画負荷の削減（GPU 負荷の最適化）
•	ポリゴン数の多いオブジェクトは Blender を用いて省ポリゴン化
•	Unity の オクルージョンカリング（非表示領域の描画スキップ） を活用
•	テクスチャ・マテリアルの最適化により GPU 負荷を軽減

2. 処理負荷の分散（CPU 負荷の最適化）

起動時など、NPC の大量生成や初期化処理に負荷が集中しやすいため、
処理を複数フレームに分散し、瞬間的な負荷ピークによるフレーム落ちを防止しています。
•	NPC 初期化・監視処理などをフレーム単位で分散実行
•	避難経路計算も負荷分散したステップ処理を採用
•	目標パフォーマンス：
o	60 FPS を安定維持
o	一般的なノートPCでも CPU スパイクが発生しない設計
 
● Arduino との実機連携（外部デバイス I/O）

Unity 内で処理した避難誘導情報を 物理デバイスに同期させることで、実際の導入時の挙動を営業現場で再現できるようにしています。

1. LED 誘導灯の点灯制御
•	Unity で算出した「推奨避難方向」を Arduino へ送信
•	Arduino 側で該当方向の LED を点灯し、仮想空間の誘導表示と物理デバイスを同期

→ 仮想と実機で統一された誘導表現を提示可能。
 
2. タクトスイッチによる災害発生トリガー
•	物理ボタン押下を 擬似的な火災検知器の反応として扱い、Arduino → Unity に通知
•	Unity 内で対応する火災イベントを即時発生

→ 営業デモ中に「この地点で火災が発生したら？」を直感的に再現可能。
 
3. 実装方法
•	Arduino IDE でスケッチ作成
•	Unity ↔ Arduino の通信は シリアル通信（接続ポートを動的に検出して接続）
•	Unity 内の誘導ロジックと実機表示が一致する、**小型の“ミニチュア避難誘導システム”**として活用可能

 
■ 実装済みの主要要素

● 1. プレイヤー操作（探索・避難体験）
•	CharacterController による歩行・ダッシュ・しゃがみ
•	一人称／三人称カメラ切り替え
•	災害発生時の視覚演出（揺れ・視界変化）

実際の避難者目線での「行動の変化」「心理的な揺さぶり」を表現するため、操作感と視界演出に重点を置いている。
 
● 2. 地震イベント
•	UI から震度 7 の揺れを即時発生
•	カメラ揺れ・地面の振動を再現（気象庁観測データのCSVファイル使用）
•	気象庁 JMAXML との連動
o	XML 構造（管理部・ヘッダ部・内容部）での取り扱いを想定し、リアルタイム発火に対応
	気象庁防災情報 XML（地震情報）仕様
	地震（予報）＜主要動到達まで〜〜＞
	緊急地震速報（現地震度など）
	震源情報
	時差で情報到達→リアルな地震情報取得の流れを再現
 
● 3. 火災イベント
火災イベントは、地下街内の複数ポイントに配置された「仮想火災センサー」を、任意のトリガーで検出できる設計
•	(1) 火災検知のトリガー
o	Unity 内の UI から、任意のゾーン（仮想センサー）を選択
o	キーボード操作（キー押下）、もしくはArduino に接続したタクトスイッチを押すことで、あらかじめ UI で選択しておいたゾーン群の火災センサーをまとめて検知状態にする
→ 営業デモ中に「この交差点で火災が起きたら？」「この一帯が火災になったら？」を
UI 操作＋キーボード操作または物理ボタン一つで即座に再現可能
•	(2) ハザード情報の反映と経路再計算
o	火災センサーが検知状態→そのゾーンに対応するノード／エッジ（通路・交差点）が“危険エリア”としてフラグ付け
o	これらの危険ノード／エッジを 経路探索の対象から除外 したうえで、避難経路の再探索
o	→火災発生前とは異なる「安全側に迂回する避難方向」を即座に再提示
 
● 4. NPC 避難者行動
全体アーキテクチャ
NPC は 行動制御・移動・アニメーション の3要素で構成
避難時には、建物内に設置された避難誘導看板を見て避難経路を辿る
地震開始／終了イベントはシステム側から通知され、NPC の行動状態を一括制御
 
行動状態管理（ステートマシン）

NPC は 平常時の徘徊 → 地震の安全確保（しゃがみ） → 立ち上がり → 避難 の流れを状態機械で管理
地震時は個体差ディレイを加えて動作をずらし、人によって反応タイミングが異なるように調整
避難状態に入ると、出口方向へ向かうための経路探索ロジックが有効化
 
避難行動（看板誘導）
避難中、NPC は視界内の看板を検出し、そこから取得した「次に進むべき方向」に沿って移動
火災などでルートが封鎖された場合は即座に経路の再探索され、避難誘導看板に反映
NPCは避難誘導看板の指示に従い安全な経路を辿って出口まで向かう
 
群集挙動の再現（追い越し・追従）

NPC 同士が密集しすぎないよう、前方距離の維持や速度調整（追従）、横方向への避け動作（追い越し）などの ローカル回避行動を実装
単純な“隊列移動”ではなく、人の流れが変化する群集らしい動きの表現を重視
 
地震から避難までの一連の流れ（NPC視点）

平常時は周囲を徘徊、地震発生後はしゃがみ姿勢で安全確保
地震収束後に順次立ち上がり避難誘導看板の指示を基に避難行動を開始
途中で火災が発生した場合やルートが変更された場合も、避難誘導看板からの指示に従い自動的に新ルートへ切り替えながら出口へ避難
